- name: Install Docker
  hosts: ubuntu
  remote_user: jaehong21
  become: true
  gather_facts: true

  vars:
    ubuntu_codename: "{{ ansible_facts.lsb.codename }}"
    docker_keyring_dir: /etc/apt/keyrings
    docker_keyring_path: /etc/apt/keyrings/docker.asc

  tasks:
    - name: Check if docker is present
      ansible.builtin.command: bash -lc 'command -v docker'
      register: docker_check
      changed_when: false
      failed_when: false

    # If found: say so, then end the play right away
    - name: Docker already installed — stop play
      when: docker_check.rc == 0
      block:
        - ansible.builtin.debug:
            msg: "Docker is already installed."
        - meta: end_play

    # If not found: do the install (and any other tasks you need)
    - name: Install Docker
      when: docker_check.rc != 0
      block:
        # https://docs.docker.com/engine/install/ubuntu/
        - name: Print architecture variables
          ansible.builtin.debug:
            msg: "Architecture: {{ ansible_architecture }}, Codename: {{ ansible_lsb.codename }}"

        - name: Get dpkg architecture (e.g., amd64, arm64)
          ansible.builtin.command: dpkg --print-architecture
          register: dpkg_arch
          changed_when: false

        - name: Ensure prerequisite packages are installed
          ansible.builtin.apt:
            name:
              - ca-certificates
              - curl
              - gnupg
            state: present
            update_cache: true

        - name: Ensure keyrings directory exists
          ansible.builtin.file:
            path: "{{ docker_keyring_dir }}"
            state: directory
            mode: "0755"

        - name: Download Docker’s official GPG key
          ansible.builtin.get_url:
            url: https://download.docker.com/linux/ubuntu/gpg
            dest: "{{ docker_keyring_path }}"
            mode: "0644"

        - name: Add Docker APT repository
          ansible.builtin.apt_repository:
            repo: >-
              deb [arch={{ dpkg_arch.stdout }} signed-by={{ docker_keyring_path }}] https://download.docker.com/linux/ubuntu {{ ubuntu_codename }} stable
            filename: docker
            state: present

        - name: Update apt cache
          ansible.builtin.apt:
            update_cache: true
          changed_when: false

        - name: Install Docker packages
          ansible.builtin.apt:
            name:
              - docker-ce
              - docker-ce-cli
              - containerd.io
              - docker-buildx-plugin
              - docker-compose-plugin
            state: present

        - name: Add Docker group
          ansible.builtin.group:
            name: docker
            state: present

        - name: Add user to Docker group
          ansible.builtin.user:
            name: "{{ ansible_user }}"
            groups: docker
            append: true

        - name: Enable and start Docker service
          ansible.builtin.systemd:
            name: "{{ item }}"
            enabled: true
            state: started
          loop:
            - docker
            - containerd

        - name: Show Docker service status (summary)
          ansible.builtin.command: systemctl --no-pager --full status docker
          register: docker_status
          changed_when: false

        - name: Print Docker service status
          ansible.builtin.debug:
            var: docker_status.stdout
